# syntax=docker/dockerfile:1.7
# Ubuntu test image with PHP built from source in ZTS mode
# Used for testing the extension with FrankenPHP and other ZTS environments

ARG DEBIAN_FRONTEND=noninteractive
ARG PHP_VERSION=8.3
ARG PHP_SRC_REF=PHP-${PHP_VERSION}

FROM ubuntu:24.04 AS base
SHELL ["/bin/bash", "-eo", "pipefail", "-c"]

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Etc/UTC \
    LC_ALL=C.UTF-8 \
    LANG=C.UTF-8 \
    LANGUAGE=C.UTF-8 \
    PHP_VERSION=${PHP_VERSION}

# Install base dependencies and build tools
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      ca-certificates curl gnupg lsb-release tzdata locales \
      software-properties-common apt-transport-https \
      git make unzip xz-utils \
      build-essential autoconf bison re2c pkg-config \
      libxml2-dev libsqlite3-dev libcurl4-openssl-dev libssl-dev \
      libzip-dev libonig-dev libjpeg-dev libpng-dev libwebp-dev \
      libicu-dev libreadline-dev libxslt1-dev default-libmysqlclient-dev cmake \
    && rm -rf /var/lib/apt/lists/*

# Timezone to UTC
RUN ln -fs /usr/share/zoneinfo/${TZ} /etc/localtime && \
    echo "${TZ}" > /etc/timezone && \
    dpkg-reconfigure -f noninteractive tzdata

# Fetch and build PHP from source with ZTS
FROM base AS php-build
ARG PHP_SRC_REF
WORKDIR /usr/src
RUN git clone --depth 1 --branch "${PHP_SRC_REF}" https://github.com/php/php-src.git
WORKDIR /usr/src/php-src

RUN sed -i 's/\[\([0-9]\+\.[0-9]\+\.[0-9]\+\)-dev\]/[\1]/' configure.ac
RUN ./buildconf --force

# Patch openssl.c for OpenSSL compatibility
RUN if [ -f ext/openssl/openssl.c ] && grep -q 'REGISTER_LONG_CONSTANT("OPENSSL_SSLV23_PADDING"' ext/openssl/openssl.c; then \
    awk '/REGISTER_LONG_CONSTANT\("OPENSSL_SSLV23_PADDING"/ { \
        indent = $0; \
        gsub(/[^[:space:]].*/, "", indent); \
        print indent "#ifdef RSA_SSLV23_PADDING"; \
        gsub(/^[[:space:]]*/, indent "    "); \
        print; \
        print indent "#endif"; \
        next \
    } \
    { print }' ext/openssl/openssl.c > ext/openssl/openssl.c.new && \
    mv ext/openssl/openssl.c.new ext/openssl/openssl.c; \
    fi || true

RUN mkdir -p /usr/local/etc/php/conf.d

# Apache: switch to prefork for mod_php scenario and enable rewrite
RUN a2dismod mpm_event || true && \
    a2dismod mpm_worker || true && \
    a2enmod mpm_prefork rewrite cgi cgid || true

ARG PHP_VERSION
COPY --from=base /usr/local/include /usr/local/include
COPY --from=base /usr/local/lib /usr/local/lib

RUN ./configure \
      --prefix=/usr/local \
      --with-config-file-path=/usr/local/lib \
      --with-config-file-scan-dir=/usr/local/etc/php/conf.d \
      --enable-zts \
      --enable-maintainer-zts \
      --enable-fpm \
      --enable-mbstring \
      --enable-pcntl \
      --enable-cgi \
      --enable-embed \
      --enable-dom \
      --enable-xml \
      --enable-simplexml \
      --enable-xmlreader \
      --enable-xmlwriter \
      --with-xsl \
      --with-extra-version="" \
      --with-curl \
      --with-mysqli \
      --with-openssl \
      --with-zlib \
      --with-zip \
      --disable-zend-signals \
      --enable-zend-max-execution-timers \
&& make -j"$(nproc)" \
&& make install \
&& strip /usr/local/bin/php /usr/local/sbin/php-fpm || true

WORKDIR /usr/src
RUN git clone https://github.com/e-dant/watcher.git
WORKDIR /usr/src/watcher
RUN cmake -S . -B build \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr/local \
    -DBUILD_LIB=ON \
    -DBUILD_BIN=ON \
    -DBUILD_HDR=ON && \
    cmake --build build && \
    cmake --install build && \
    ldconfig

# Final image with PHP and test infrastructure
FROM base AS final

COPY --from=php-build /usr/local /usr/local

RUN echo "/usr/local/lib" > /etc/ld.so.conf.d/usr-local-lib.conf && \
    ldconfig

COPY frankenphp-binary/ /tmp/frankenphp-binary/
RUN if [ -f /tmp/frankenphp-binary/frankenphp ]; then \
            cp /tmp/frankenphp-binary/frankenphp /usr/bin/frankenphp && \
            chmod +x /usr/bin/frankenphp && \
            mkdir -p /etc/frankenphp/caddy.d && \
            mkdir -p /etc/frankenphp/php.d && \
            mkdir -p /usr/lib/frankenphp/modules; \
        fi


RUN EXTENSION_DIR=$(php -i | grep "^extension_dir" | awk '{print $3}') && \
    if [ -z "$EXTENSION_DIR" ]; then \
        echo "Error: Could not determine extension_dir"; \
        exit 1; \
    fi && \
    mkdir -p "$EXTENSION_DIR" \
    echo "Created extension_dir: $EXTENSION_DIR"

# Verify ZTS is enabled
RUN php -v | grep -q "ZTS" || (echo "ERROR: ZTS not enabled!" && exit 1) && \
    php -m | grep -E 'curl|mysqli' >/dev/null

ENV PATH="/usr/local/bin:${PATH}" \
    LD_LIBRARY_PATH="/usr/local/lib:${LD_LIBRARY_PATH:-}"

RUN ln -sf /usr/local/bin/php /usr/bin/php && \
    ln -sf /usr/local/sbin/php-fpm /usr/sbin/php-fpm || true && \
    ln -sf /usr/local/bin/php-cgi /usr/bin/php-cgi

RUN PHP_VER=$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;') && \
    mkdir -p /etc/php/${PHP_VER}/fpm && \
    mkdir -p /etc/php/${PHP_VER}/fpm/pool.d && \
    mkdir -p /run/php && \
    mkdir -p /run/php-fpm && \
    mkdir -p /var/run && \
    mkdir -p /var/log && \
    mkdir -p /usr/local/etc/php-fpm.d && \
    mkdir -p /usr/local/etc/php/conf.d && \

    ln -sf /usr/local/etc/php/conf.d /etc/php/${PHP_VER}/fpm/conf.d || true && \

    echo "[global]" > /usr/local/etc/php-fpm.conf && \
    echo "pid = /run/php-fpm/php-fpm.pid" >> /usr/local/etc/php-fpm.conf && \
    echo "error_log = /var/log/php${PHP_VER}-fpm.log" >> /usr/local/etc/php-fpm.conf && \
    echo "daemonize = yes" >> /usr/local/etc/php-fpm.conf && \
    echo "include=/usr/local/etc/php-fpm.d/*.conf" >> /usr/local/etc/php-fpm.conf && \
    echo "include=/etc/php/${PHP_VER}/fpm/pool.d/*.conf" >> /usr/local/etc/php-fpm.conf && \

    echo "[www]" > /usr/local/etc/php-fpm.d/www.conf && \
    echo "user = root" >> /usr/local/etc/php-fpm.d/www.conf && \
    echo "group = root" >> /usr/local/etc/php-fpm.d/www.conf && \
    echo "listen = 127.0.0.1:9000" >> /usr/local/etc/php-fpm.d/www.conf && \
    echo "listen.owner = root" >> /usr/local/etc/php-fpm.d/www.conf && \
    echo "listen.group = root" >> /usr/local/etc/php-fpm.d/www.conf && \
    echo "pm = dynamic" >> /usr/local/etc/php-fpm.d/www.conf && \
    echo "pm.max_children = 5" >> /usr/local/etc/php-fpm.d/www.conf && \
    echo "pm.start_servers = 2" >> /usr/local/etc/php-fpm.d/www.conf && \
    echo "pm.min_spare_servers = 1" >> /usr/local/etc/php-fpm.d/www.conf && \
    echo "pm.max_spare_servers = 3" >> /usr/local/etc/php-fpm.d/www.conf && \

    php-fpm -t -y /usr/local/etc/php-fpm.conf 2>&1 | grep -v "Nothing matches the include pattern" || true && \
    php-fpm -t -y /usr/local/etc/php-fpm.conf >/dev/null 2>&1 || \
    (PHP_MAJOR=$(php -r 'echo PHP_MAJOR_VERSION;') && \
     PHP_MINOR=$(php -r 'echo PHP_MINOR_VERSION;') && \
     echo "PHP-FPM config test failed for PHP ${PHP_MAJOR}.${PHP_MINOR}" && \
     echo "Config file contents:" && cat /usr/local/etc/php-fpm.conf && \
     echo "Pool config:" && cat /usr/local/etc/php-fpm.d/www.conf && \
     exit 1) && \

    ln -sf /usr/local/etc/php-fpm.conf /etc/php/${PHP_VER}/fpm/php-fpm.conf && \
    ln -sf /usr/local/etc/php-fpm.d/www.conf /etc/php/${PHP_VER}/fpm/pool.d/www.conf || true

RUN echo "mysqli.default_socket = /var/lib/mysql/mysql.sock" > /usr/local/etc/php/conf.d/mysql-socket.ini

RUN if [ -f /usr/local/bin/frankenphp ]; then \
        frankenphp -v || echo "Warning: frankenphp version check failed"; \
    else \
        echo "WARNING: frankenphp binary not found; FrankenPHP-specific tests will be skipped."; \
    fi

# Install web servers and database (without PHP packages)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      nginx \
      apache2 \
      mariadb-server \
      apache2-bin \
    && rm -rf /var/lib/apt/lists/*


RUN service apache2 stop || true

# Apache: switch to prefork for mod_php scenario and enable rewrite
RUN a2dismod mpm_event || true && \
    a2dismod mpm_worker || true && \
    a2enmod mpm_prefork rewrite cgi cgid || true

RUN service apache2 start || true

# ---- Python toolchain used by tests ----
ENV PIP_DISABLE_PIP_VERSION_CHECK=1 \
  PYTHONDONTWRITEBYTECODE=1 \
  VIRTUAL_ENV=/opt/ci-venv \
  PATH="/opt/ci-venv/bin:${PATH}"

RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 python3-venv python3-pip python3-dev \
  && python3 -m venv "$VIRTUAL_ENV" \
  && "$VIRTUAL_ENV/bin/pip" install --no-cache-dir \
       flask pandas psutil requests \
  && apt-get clean && rm -rf /var/lib/apt/lists/*

# Helper: start MariaDB 
RUN mkdir -p /usr/local/bin /var/lib/mysql /run/mysqld && \
    printf '%s\n' '#!/usr/bin/env bash' \
      'set -euo pipefail' \
      'mkdir -p /var/lib/mysql /run/mysqld' \
      'chown -R mysql:mysql /var/lib/mysql /run/mysqld' \
      'if [ ! -d /var/lib/mysql/mysql ]; then' \
      '  mysqld --initialize-insecure --user=mysql --datadir=/var/lib/mysql' \
      'fi' \
      'mysqld --user=mysql --datadir=/var/lib/mysql &' \
      'pid=$!' \
      'for i in {1..30}; do mysqladmin ping --silent && break; sleep 1; done' \
      'mysql -u root -e "CREATE DATABASE IF NOT EXISTS db;" || true' \
      'mysql -u root -e "ALTER USER '\''root'\''@'\''localhost'\'' IDENTIFIED BY '\''pwd'\''; FLUSH PRIVILEGES;" || true' \
      'wait $pid' \
    > /usr/local/bin/start-mariadb && \
    chmod +x /usr/local/bin/start-mariadb

# Create PHP-CGI symlink for CGI tests (using source-built PHP)
RUN mkdir -p /usr/lib/cgi-bin && \
    ln -sf /usr/local/bin/php-cgi /usr/lib/cgi-bin/php-cgi || \
    (echo "Note: php-cgi may not be available in source build" && true)

WORKDIR /work
CMD ["bash"]





