# syntax=docker/dockerfile:1.7

ARG BASE_IMAGE=ubuntu:24.04
ARG PHP_VERSION=7.2
# Default ref is PHP-${PHP_VERSION} but can be overridden if needed
ARG PHP_SRC_REF=PHP-${PHP_VERSION}

############################
# Base: common OS setup
############################
FROM ${BASE_IMAGE} AS base
SHELL ["/bin/bash", "-eo", "pipefail", "-c"]

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Etc/UTC \
    LC_ALL=C.UTF-8 \
    LANG=C.UTF-8 \
    LANGUAGE=C.UTF-8

RUN apt-get update \
 && apt-get install -y --no-install-recommends tzdata ca-certificates git wget curl xz-utils \
 && ln -fs /usr/share/zoneinfo/${TZ} /etc/localtime \
 && echo "${TZ}" > /etc/timezone \
 && dpkg-reconfigure -f noninteractive tzdata \
 && update-ca-certificates \
 && git config --global http.sslCAInfo /etc/ssl/certs/ca-certificates.crt \
 && git config --global http.sslVerify true \
 && rm -rf /var/lib/apt/lists/*

############################
# Builder: toolchain + dev libs
############################
FROM base AS build-deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential autoconf bison re2c pkg-config \
    libxml2-dev libsqlite3-dev libcurl4-openssl-dev libssl-dev \
    libzip-dev libonig-dev libjpeg-dev libpng-dev libwebp-dev \
    libicu-dev libreadline-dev libxslt1-dev default-libmysqlclient-dev \
    wget tar \
 && rm -rf /var/lib/apt/lists/*

############################
# Fetch php-src
############################
FROM build-deps AS php-src
ARG PHP_SRC_REF
WORKDIR /usr/src
RUN git clone --depth 1 --branch "${PHP_SRC_REF}" https://github.com/php/php-src.git
WORKDIR /usr/src/php-src
RUN ./buildconf --force

############################
# Build PHP
############################
FROM php-src AS php-build
# Configure flags mirror your workflow; adjust as needed
RUN ./configure \
      --prefix=/usr/local \
      --with-config-file-path=/usr/local/lib \
      --with-config-file-scan-dir=/usr/local/etc/php/conf.d \
      --enable-mbstring \
       --enable-pcntl \
      # --enable-intl \
       --enable-cli \
       --with-curl \
       --with-mysqli \
        --with-sqlite3 \
    #    --with-openssl \
       --with-zlib \
       --with-zip \
 && make -j"$(nproc)" \
 && make install \
 && strip /usr/local/bin/php || true

############################
# Final: DEV image (keeps toolchain so you can phpize/build extensions fast)
############################
FROM build-deps AS dev
ARG PHP_VERSION
COPY --from=php-build /usr/local /usr/local
# Sanity check and helpful defaults
RUN php -v && php -m | grep -E 'curl|mysqli|sqlite3' >/dev/null
ENV PATH="/usr/local/bin:${PATH}"
# phpize is available from the source build in /usr/local/bin
# Create extension config dir
RUN mkdir -p /usr/local/etc/php/conf.d


RUN apt-get update && apt-get install -y --no-install-recommends \
    nginx php-fpm \
 && rm -rf /var/lib/apt/lists/*

RUN apt-get update && apt-get install -y --no-install-recommends \
    apache2 \
 && rm -rf /var/lib/apt/lists/*

RUN apt-get update && apt-get install -y --no-install-recommends \
    mariadb-server \
 && mkdir -p /var/lib/mysql \
 && mkdir -p /run/mysqld


RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common ca-certificates lsb-release apt-transport-https \
 && add-apt-repository ppa:ondrej/php -y \
 && apt-get update \
 && apt-get install -y libapache2-mod-php${PHP_VERSION} \
 && a2enmod php${PHP_VERSION} \
 && apt-get install -y php${PHP_VERSION}-mysqli \
 && apt-get install -y php${PHP_VERSION}-pdo \
 && apt-get install -y php${PHP_VERSION}-cgi \
 && apt-get install -y libapache2-mod-fcgid \
 && apt-get install -y libfcgi-bin \    
 && php -i

RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 python3-flask python3-pandas python3-psutil python3-requests \
 && rm -rf /var/lib/apt/lists/*


WORKDIR /work
CMD ["php", "-v"]

