name: Tester Action

on:
  workflow_dispatch:
    # a tag is passed in
    inputs:
      tag:
        description: The tag to test
        required: true
        type: string

permissions:
  contents: read
  
jobs:
  test-php:
    name: PHP Tests (zen-demo-php)
    runs-on: ubuntu-latest
    steps:
      - name: Print tag
        run: 'echo "The tag is: ${{ inputs.tag }}"'


      - name: Checkout demo app
        uses: actions/checkout@v4
        with:
          repository: Aikido-demo-apps/zen-demo-php
          path: ./zen-demo
          ref: main
          token: ${{ secrets.DEMO_APPS_DOWNLOAD_TOKEN }}
          submodules: recursive

      - name: Test Local Action
        id: test-action
        uses: AikidoSec/firewall-tester-action@releases/v1
        with:
          dockerfile_path: ./zen-demo/Dockerfile
          extra_args:
            '--env-file=./zen-demo/.env.example -e
            APP_KEY=base64:W2v6u6VR4lURkxuMT9xZ6pdhXSt5rxsmWTbd1HGqlIM='
          sleep_before_test: 20
          skip_tests: test_api_spec
          extra_build_args: "--build-arg PHP_FIREWALL_VERSION=${{ inputs.tag }}"
          
     