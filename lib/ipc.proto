syntax = "proto3";

import "google/protobuf/empty.proto";

package ipc;

option go_package = "ipc/protos;protos";

service Aikido {
  rpc OnConfig (Config) returns (google.protobuf.Empty);
  rpc OnPackages(Packages) returns (google.protobuf.Empty);
  rpc OnDomain (Domain) returns (google.protobuf.Empty);
  rpc GetRateLimitingStatus (RateLimitingInfo) returns (RateLimitingStatus);
  rpc OnRequestShutdown (RequestMetadataShutdown) returns (google.protobuf.Empty);
  rpc GetCloudConfig(CloudConfigUpdatedAt) returns (CloudConfig);
  rpc OnUser(User) returns (google.protobuf.Empty);
  rpc OnAttackDetected(AttackDetected) returns (google.protobuf.Empty);
  rpc OnMonitoredSinkStats(MonitoredSinkStats) returns (google.protobuf.Empty);
  rpc OnMiddlewareInstalled(MiddlewareInstalledInfo) returns (google.protobuf.Empty);
  rpc OnMonitoredIpMatch(MonitoredIpMatch) returns (google.protobuf.Empty);
  rpc OnMonitoredUserAgentMatch(MonitoredUserAgentMatch) returns (google.protobuf.Empty);
}

message Config {
  string token = 1;
  int32 server_pid = 2;
  string platform_name = 3;
  string platform_version = 4;
  string endpoint = 5;
  string config_endpoint = 6;
  string log_level = 7;
  bool disk_logs = 8;
  bool blocking = 9;
  bool localhost_allowed_by_default = 10;
  bool collect_api_schema = 11;
  int32 request_processor_pid = 12;
}

message Packages {
  string token = 1;
  int32 server_pid = 2;
  map<string, string> packages = 3;
}

message Domain {
  string token = 1;
  int32 server_pid = 2;
  string domain = 3;
  uint32 port = 4;
}

message RateLimitingInfo {
  string token = 1;
  int32 server_pid = 2;
  string method = 3;
  string route = 4;
  string routeParsed = 5;
  string user = 6;
  string ip = 7;
  string rateLimitGroup = 8;
}

message RequestMetadataShutdown {
  string token = 1;
  string method = 2;
  string route = 3;
  string routeParsed = 4;
  int32 statusCode = 5;
  string user = 6;
  string userAgent = 7;
  string ip = 8;
  string rateLimitGroup = 9;
  APISpec apiSpec = 10;
  bool rateLimited = 11;
  bool isWebScanner = 12;
  bool shouldDiscoverRoute = 13;
}

message MiddlewareInstalledInfo {
  string token = 1;
  int32 server_pid = 2;
}

message MonitoredSinkStats {
  string token = 1;
  int32 server_pid = 2;
  string sink = 3;
  string kind = 4;
  int32 attacksDetected = 5;
  int32 attacksBlocked = 6;
  int32 interceptorThrewError = 7;
  int32 withoutContext = 8;
  int32 total = 9;
  repeated int64 timings = 10;
}

message RateLimiting {
  bool enabled = 1;
}

message Endpoint {
  string method = 1;
  string route = 2;
  bool forceProtectionOff = 3;
  RateLimiting rateLimiting = 4;
  repeated string allowedIPAddresses = 5;
}

message CloudConfigUpdatedAt {
  string token = 1;
  int32 server_pid = 2;
  int64 configUpdatedAt = 3;
}

message IpList {
  string key = 1;
  string description = 2;
  repeated string ips = 3;
}

message CloudConfig {
  int64 configUpdatedAt = 1;
  repeated Endpoint endpoints = 2;
  repeated string blockedUserIds = 3;
  repeated string bypassedIps = 4;
  map<string, IpList> blockedIps = 5;
  map<string, IpList> allowedIps = 6;
  string blockedUserAgents = 7;
  map<string, IpList> monitoredIps = 8;
  string monitoredUserAgents = 9;
  map<string, string> userAgentDetails = 10;
  bool block = 11;
}

message RateLimitingStatus {
  bool block = 1;
  string trigger = 2;
}

message User {
  string token = 1;
  int32 server_pid = 2;
  string id = 3;
  string username = 4;
  string ip = 5;
}

message Header {
  string key = 1;
  string value = 2;
}

message Request {
  string method = 1;
  string ipAddress = 2;
  string userAgent = 3;
  string url = 4;
  repeated Header headers = 5;
  string body = 6;
  string source = 7;
  string route = 8;
}

message Metadata {
  string key = 1;
  string value = 2;
}

message Attack {
  string kind = 1;
  string operation = 2;
  string module = 3;
  bool blocked = 4;
  string source = 5;
  string path = 6;
  string stack = 7;
  string payload = 8;
  repeated Metadata metadata = 9;
  string userId = 10;
}

message AttackDetected {
  string token = 1;
  int32 server_pid = 2;
  Request request = 4;
  Attack attack = 5;
}

message APIAuthType {
	string type = 1;
	string scheme = 2;
	string in = 3;
	string name = 4;
	string bearerFormat = 5;
}

message DataSchema {
  repeated string type = 1;
  map<string, DataSchema> properties = 2;
  DataSchema items = 3;
  bool optional = 4;
}

message APIBodyInfo {
  string type = 1;
  DataSchema schema = 2;
}

message APISpec {
  APIBodyInfo body = 1;
  DataSchema query = 2;
  repeated APIAuthType auth = 3;
}

message MonitoredIpMatch {
  string token = 1;
  int32 server_pid = 2;
  repeated string lists = 3;
}

message MonitoredUserAgentMatch {
  string token = 1;
  int32 server_pid = 2;
  repeated string lists = 3;
}